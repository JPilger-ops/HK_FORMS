generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  ADMIN
  STAFF
}

enum ReservationStatus {
  NEW
  IN_PROGRESS
  CONFIRMED
  CANCELLED
}

enum InvoiceStatus {
  NONE
  SENT
  PAID
  OVERDUE
}

enum SignatureType {
  HOST
  STAFF
}

enum ExtraPricingType {
  PER_PERSON
  FLAT
}

model User {
  id           String               @id @default(uuid())
  email        String               @unique
  passwordHash String
  role         Role                 @default(STAFF)
  createdAt    DateTime             @default(now())
  lastLoginAt  DateTime?
  reservations ReservationRequest[] @relation("ReservationAssigned")
  inviteLinks  InviteLink[]         @relation("InviteCreatedBy")
}

model ReservationRequest {
  id                  String            @id @default(uuid())
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  status              ReservationStatus @default(NEW)
  hostFirstName       String?
  hostLastName        String?
  hostCompany         String?
  hostStreet          String?
  hostPostalCode      String?
  hostCity            String?
  hostPhone           String?
  hostEmail           String?
  guestName           String
  guestEmail          String
  guestPhone          String?
  guestAddress        String?           @db.Text
  eventDate           DateTime
  eventType           String
  eventStartTime      String
  eventEndTime        String
  startMeal           String?
  numberOfGuests      Int
  vegetarianGuests    Int?
  veganGuests         Int?
  paymentMethod       String
  extrasSelection     String?           @db.Text
  extrasSnapshot      Json?
  extras              String?
  priceEstimate       Decimal?          @db.Decimal(10, 2)
  totalPrice          Decimal?          @db.Decimal(10, 2)
  internalResponsible String?
  internalNotes       String?
  privacyAcceptedAt   DateTime?
  termsAcceptedAt     DateTime?
  termsSnapshot       String?           @db.Text
  legacyData          Json?
  assignedToId        String?
  assignedTo          User?             @relation("ReservationAssigned", fields: [assignedToId], references: [id])
  signatures          Signature[]
  emails              EmailLog[]
  auditLogs           AuditLog[]
  invitesUsed         InviteLink[]      @relation("InviteUsedBy")
  invoiceReference    String?
  invoiceStatus       InvoiceStatus     @default(NONE)
  invoiceSentAt       DateTime?
  invoicePaidAt       DateTime?
  invoiceOverdueSince DateTime?
  invoices            ReservationInvoice[]
}

model ExtraOption {
  id          String           @id @default(uuid())
  label       String
  description String?
  pricingType ExtraPricingType
  priceCents  Int
  isActive    Boolean          @default(true)
  sortOrder   Int              @default(0)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
}

model Signature {
  id            String             @id @default(uuid())
  reservationId String
  reservation   ReservationRequest @relation(fields: [reservationId], references: [id])
  type          SignatureType
  imageData     Bytes
  createdAt     DateTime           @default(now())

  @@unique([reservationId, type])
}

model ReservationInvoice {
  id               String             @id @default(uuid())
  reservationId    String
  reservation      ReservationRequest @relation(fields: [reservationId], references: [id])
  invoiceReference String
  firstItemLabel   String
  status           InvoiceStatus      @default(NONE)
  sentAt           DateTime?
  paidAt           DateTime?
  overdueSince     DateTime?
  createdAt        DateTime           @default(now())

  @@unique([reservationId, invoiceReference])
}

model EmailLog {
  id            String              @id @default(uuid())
  reservationId String?
  reservation   ReservationRequest? @relation(fields: [reservationId], references: [id])
  inviteLinkId  String?
  inviteLink    InviteLink?         @relation("InviteEmails", fields: [inviteLinkId], references: [id])
  to            String
  subject       String
  status        String
  error         String?
  sentAt        DateTime            @default(now())
}

model InviteLink {
  id                  String              @id @default(uuid())
  tokenHash           String              @unique
  formKey             String
  createdAt           DateTime            @default(now())
  expiresAt           DateTime?
  usedAt              DateTime?
  usedByReservationId String?
  usedByReservation   ReservationRequest? @relation("InviteUsedBy", fields: [usedByReservationId], references: [id])
  createdByUserId     String?
  createdBy           User?               @relation("InviteCreatedBy", fields: [createdByUserId], references: [id])
  recipientEmail      String?
  maxUses             Int                 @default(1)
  useCount            Int                 @default(0)
  note                String?
  isRevoked           Boolean             @default(false)
  emailLogs           EmailLog[]          @relation("InviteEmails")
}

model AuditLog {
  id            String             @id @default(uuid())
  reservationId String
  reservation   ReservationRequest @relation(fields: [reservationId], references: [id])
  userId        String?
  action        String
  createdAt     DateTime           @default(now())
}

model Setting {
  key       String   @id
  value     String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
